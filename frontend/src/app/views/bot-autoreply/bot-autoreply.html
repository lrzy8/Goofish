<div class="w-full">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">自动回复</h2>
    </div>

    <!-- 响应式两栏布局 -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- 左侧：添加/编辑表单 -->
        <div class="xl:col-span-1">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h3 class="card-title text-lg">{{ editingRule() ? '编辑规则' : '添加规则' }}</h3>

                    <form (ngSubmit)="saveRule()" class="space-y-4">
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text">规则名称 <span class="text-error">*</span></span>
                            </label>
                            <input type="text" class="input input-bordered input-sm w-full" placeholder="例如：问候语回复"
                                [ngModel]="formData().name" (ngModelChange)="updateFormField('name', $event)"
                                name="name" />
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text">匹配方式</span>
                            </label>
                            <select class="select select-bordered select-sm w-full" [ngModel]="formData().matchType"
                                (ngModelChange)="updateFormField('matchType', $event)" name="matchType">
                                @for (type of matchTypes; track type.value) {
                                <option [value]="type.value">{{ type.label }}</option>
                                }
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" class="toggle toggle-sm toggle-primary"
                                    [ngModel]="formData().excludeMatch"
                                    (ngModelChange)="updateFormField('excludeMatch', $event)" name="excludeMatch" />
                                <span class="label-text">排除匹配</span>
                            </label>
                            <label class="label py-0">
                                <span class="label-text-alt text-base-content/50">开启后匹配其他规则未匹配的所有消息</span>
                            </label>
                        </div>

                        @if (!formData().excludeMatch) {
                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text">匹配内容 <span class="text-error">*</span></span>
                            </label>
                            <input type="text" class="input input-bordered input-sm w-full"
                                [placeholder]="formData().matchType === 'ai' ? '触发关键词（逗号分隔，留空匹配所有）' : '输入要匹配的关键词或正则表达式'"
                                [ngModel]="formData().matchPattern"
                                (ngModelChange)="updateFormField('matchPattern', $event)" name="matchPattern" />
                            <label class="label py-1">
                                <span class="label-text-alt text-base-content/50">
                                    @switch (formData().matchType) {
                                    @case ('exact') { 消息内容必须完全等于此内容 }
                                    @case ('contains') { 消息内容包含此关键词即可 }
                                    @case ('regex') { 使用正则表达式匹配 }
                                    @case ('ai') { 包含任一关键词时触发 AI 回复，留空或 * 匹配所有消息 }
                                    }
                                </span>
                            </label>
                        </div>
                        }

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text">
                                    @if (formData().matchType === 'ai') {
                                    AI 提示词
                                    } @else {
                                    回复内容 <span class="text-error">*</span>
                                    }
                                </span>
                            </label>
                            <textarea class="textarea textarea-bordered textarea-sm w-full" rows="3"
                                [placeholder]="formData().matchType === 'ai' ? '定义 AI 的角色和回复风格（可选，留空使用全局设置）' : '输入自动回复的内容'"
                                [ngModel]="formData().replyContent"
                                (ngModelChange)="updateFormField('replyContent', $event)"
                                name="replyContent"></textarea>
                            @if (formData().matchType === 'ai') {
                            <label class="label py-1">
                                <span class="label-text-alt text-info">留空保存时将自动填入全局提示词</span>
                            </label>
                            @if (globalPrompt()) {
                            <div class="bg-base-200 rounded-lg p-2 mt-1">
                                <div class="text-xs text-base-content/50 mb-1">当前全局提示词：</div>
                                <div class="text-xs text-base-content/70 whitespace-pre-wrap line-clamp-3">{{
                                    globalPrompt() }}</div>
                            </div>
                            } @else {
                            <div class="text-xs text-warning mt-1">未设置全局提示词，请在系统设置中配置</div>
                            }
                            }
                        </div>

                        <div class="form-control">
                            <label class="label py-1">
                                <span class="label-text">优先级</span>
                            </label>
                            <input type="number" class="input input-bordered input-sm w-24"
                                [ngModel]="formData().priority" (ngModelChange)="updateFormField('priority', $event)"
                                name="priority" />
                            <label class="label py-1">
                                <span class="label-text-alt text-base-content/50">数字越大优先级越高</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-2 py-1">
                                <input type="checkbox" class="checkbox checkbox-sm checkbox-primary"
                                    [ngModel]="formData().enabled" (ngModelChange)="updateFormField('enabled', $event)"
                                    name="enabled" />
                                <span class="label-text">启用此规则</span>
                            </label>
                        </div>

                        <div class="flex gap-2">
                            <button type="submit" [disabled]="saving()" class="btn btn-primary btn-sm flex-1 gap-1">
                                @if (saving()) {
                                <span class="loading loading-spinner loading-xs"></span>
                                } @else {
                                <lucide-icon [img]="editingRule() ? icons.Save : icons.Plus"
                                    class="w-4 h-4"></lucide-icon>
                                }
                                {{ editingRule() ? '保存' : '添加' }}
                            </button>
                            @if (editingRule()) {
                            <button type="button" (click)="cancelEdit()" class="btn btn-ghost btn-sm">取消</button>
                            }
                        </div>
                    </form>
                </div>
            </div>

            <!-- 帮助卡片 -->
            <div class="card bg-base-100 shadow mt-4">
                <div class="card-body py-4">
                    <div class="flex items-center gap-2">
                        <lucide-icon [img]="icons.HelpCircle" class="w-4 h-4 text-base-content/50"></lucide-icon>
                        <span class="text-sm font-medium">匹配方式说明</span>
                    </div>
                    <ul class="text-xs text-base-content/60 space-y-1 mt-2">
                        <li><span class="font-medium">精确匹配：</span>消息内容必须完全等于匹配内容</li>
                        <li><span class="font-medium">包含关键词：</span>消息中包含关键词即触发</li>
                        <li><span class="font-medium">正则表达式：</span>使用正则匹配，如 <code
                                class="bg-base-200 px-1 rounded">你好|hi|hello</code></li>
                        <li><span class="font-medium text-primary">AI 回复：</span>使用 AI 生成智能回复，需先在系统设置中配置 AI 服务</li>
                        <li><span class="font-medium text-warning">排除匹配：</span>匹配其他规则都未匹配的消息，适合作为兜底规则</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 右侧：规则列表 -->
        <div class="xl:col-span-2">
            <div class="card bg-base-100 shadow">
                <div class="card-body p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-medium">规则列表</h3>
                        <button class="btn btn-sm btn-ghost" (click)="loadRules()" [disabled]="loading()">
                            <lucide-icon [img]="icons.RefreshCw" class="w-4 h-4"
                                [class.animate-spin]="loading()"></lucide-icon>
                        </button>
                    </div>

                    @if (loading()) {
                    <div class="flex justify-center py-12">
                        <span class="loading loading-spinner loading-lg text-primary"></span>
                    </div>
                    } @else if (rules().length === 0) {
                    <div class="text-center py-12 text-base-content/50">
                        <lucide-icon [img]="icons.MessageCircle"
                            class="w-12 h-12 mx-auto mb-2 opacity-30"></lucide-icon>
                        <p>暂无自动回复规则</p>
                        <p class="text-sm mt-1">在左侧添加第一条规则</p>
                    </div>
                    } @else {
                    <!-- 桌面端表格 -->
                    <div class="overflow-x-auto hidden lg:block">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>状态</th>
                                    <th>名称</th>
                                    <th>匹配方式</th>
                                    <th>匹配内容</th>
                                    <th>回复内容</th>
                                    <th>优先级</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (rule of rules(); track rule.id) {
                                <tr class="hover">
                                    <td>
                                        <input type="checkbox" class="toggle toggle-sm toggle-success"
                                            [checked]="rule.enabled" (change)="toggleRule(rule)" />
                                    </td>
                                    <td class="font-medium">{{ rule.name }}</td>
                                    <td>
                                        <span class="badge badge-ghost badge-sm">{{ getMatchTypeName(rule.matchType)
                                            }}</span>
                                    </td>
                                    <td class="max-w-32 truncate" [title]="rule.matchPattern">
                                        @if (rule.excludeMatch) {
                                        <span class="text-base-content/50">(排除其他规则)</span>
                                        } @else {
                                        {{ rule.matchPattern || '(所有消息)' }}
                                        }
                                    </td>
                                    <td class="max-w-40 truncate" [title]="rule.replyContent">
                                        @if (rule.matchType === 'ai') {
                                        <span class="text-info">{{ rule.replyContent || '(使用全局提示词)' }}</span>
                                        } @else {
                                        {{ rule.replyContent }}
                                        }
                                    </td>
                                    <td>{{ rule.priority }}</td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-ghost btn-xs btn-square" (click)="onEdit(rule)"
                                                title="编辑">
                                                <lucide-icon [img]="icons.Edit" class="w-3.5 h-3.5"></lucide-icon>
                                            </button>
                                            <button class="btn btn-error btn-xs btn-square" (click)="deleteRule(rule)"
                                                title="删除">
                                                <lucide-icon [img]="icons.Trash2" class="w-3.5 h-3.5"></lucide-icon>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- 移动端卡片 -->
                    <div class="lg:hidden space-y-3">
                        @for (rule of rules(); track rule.id) {
                        <div class="card card-bordered">
                            <div class="card-body p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" class="toggle toggle-sm toggle-success"
                                            [checked]="rule.enabled" (change)="toggleRule(rule)" />
                                        <span class="font-medium">{{ rule.name }}</span>
                                    </div>
                                    <span class="badge badge-ghost badge-sm">{{ getMatchTypeName(rule.matchType)
                                        }}</span>
                                </div>
                                <div class="text-sm mt-2 space-y-1">
                                    <div class="flex gap-2">
                                        <span class="text-base-content/50 shrink-0">匹配:</span>
                                        @if (rule.excludeMatch) {
                                        <span class="text-base-content/50">(排除其他规则)</span>
                                        } @else {
                                        <span class="truncate">{{ rule.matchPattern || '(所有消息)' }}</span>
                                        }
                                    </div>
                                    <div class="flex gap-2">
                                        <span class="text-base-content/50 shrink-0">
                                            {{ rule.matchType === 'ai' ? '提示词:' : '回复:' }}
                                        </span>
                                        @if (rule.matchType === 'ai') {
                                        <span class="truncate text-info">{{ rule.replyContent || '(使用全局提示词)' }}</span>
                                        } @else {
                                        <span class="truncate">{{ rule.replyContent }}</span>
                                        }
                                    </div>
                                </div>
                                <div class="card-actions justify-between items-center mt-2">
                                    <span class="text-xs text-base-content/50">优先级: {{ rule.priority }}</span>
                                    <div class="flex gap-1">
                                        <button class="btn btn-ghost btn-xs" (click)="onEdit(rule)">编辑</button>
                                        <button class="btn btn-error btn-xs" (click)="deleteRule(rule)">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>