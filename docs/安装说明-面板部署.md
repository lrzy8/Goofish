# GoofishCBot 面板部署安装说明

本文档详细说明如何在宝塔面板、1Panel、雨云面板等 Linux 服务器面板上部署 GoofishCBot。

## 📋 前置要求

### 系统要求
- **操作系统**：Ubuntu 22.04 / Debian 12 / CentOS 9 或更高版本
- **面板**：宝塔面板 / 1Panel / 雨云面板 / 其他支持 Node.js 的面板
- **Node.js**：版本 >= 18（推荐使用 Node.js 20 LTS）
- **npm**：版本 >= 9
- **内存**：建议至少 512MB 可用内存
- **磁盘空间**：建议至少 500MB 可用空间

### 面板要求
- 已安装并配置好面板
- 具有 SSH 访问权限或面板终端功能
- 可以创建网站/应用

---

## 🚀 安装步骤

### 第一步：准备服务器环境

#### 1.1 登录服务器面板
- 打开你的面板管理界面（如：`http://你的服务器IP:8888`）
- 使用管理员账号登录

#### 1.2 安装 Node.js（如果未安装）

**宝塔面板：**
1. 进入「软件商店」
2. 搜索「Node.js 版本管理器」或「PM2」
3. 点击「安装」
4. 安装完成后，在「软件商店」→「已安装」中找到 Node.js 版本管理器
5. 点击「设置」，安装 Node.js 20 LTS 版本

**1Panel：**
1. 进入「应用商店」
2. 搜索「Node.js」
3. 点击「安装」，选择 Node.js 20 版本

**通过 SSH 安装（通用方法）：**
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node -v  # 应显示 v20.x.x
npm -v   # 应显示 9.x.x 或更高
```

---

### 第二步：上传项目文件

#### 2.1 创建项目目录

**宝塔面板：**
1. 进入「文件」管理
2. 导航到 `/www/wwwroot/` 目录
3. 点击「新建文件夹」，命名为 `goofishcbot`
4. 进入 `goofishcbot` 文件夹

**1Panel：**
1. 进入「文件管理」
2. 导航到 `/opt/` 或你希望存放应用的目录
3. 创建文件夹 `goofishcbot`

**通过 SSH：**
```bash
sudo mkdir -p /www/wwwroot/goofishcbot
# 或
sudo mkdir -p /opt/goofishcbot
```

#### 2.2 上传项目文件

**方法一：通过面板文件管理器上传**
1. 在本地将项目文件夹压缩为 ZIP 文件
2. 在面板文件管理器中，进入 `goofishcbot` 目录
3. 点击「上传」，选择 ZIP 文件
4. 上传完成后，右键点击 ZIP 文件，选择「解压」
5. 确保解压后的文件结构正确（应包含 `package.json`、`src/`、`frontend/` 等文件夹）

**方法二：通过 Git 克隆（推荐）**
```bash
cd /www/wwwroot/goofishcbot
# 或
cd /opt/goofishcbot

# 克隆项目（如果项目在 GitHub 上）
git clone https://github.com/haiyewei/GoofishCredentialsBot.git .

# 如果没有 Git，先安装
# Ubuntu/Debian: sudo apt-get install git
# CentOS: sudo yum install git
```

**方法三：通过 SCP 上传（本地有项目文件）**
```bash
# 在本地电脑执行（Windows 使用 PowerShell 或 Git Bash）
scp -r ./GoofishCredentialsBot-1.0.0/* root@你的服务器IP:/www/wwwroot/goofishcbot/
```

---

### 第三步：安装项目依赖

#### 3.1 打开终端

**宝塔面板：**
1. 点击面板右上角的「终端」图标
2. 或进入「文件」→ 找到项目目录 → 点击「终端」

**1Panel：**
1. 进入「终端」
2. 或使用 SSH 客户端连接服务器

#### 3.2 安装后端依赖

```bash
# 进入项目目录
cd /www/wwwroot/goofishcbot
# 或
cd /opt/goofishcbot

# 安装后端依赖
npm install

# 等待安装完成（可能需要几分钟）
```

#### 3.3 安装前端依赖

```bash
# 进入前端目录
cd frontend

# 安装前端依赖
npm install

# 返回项目根目录
cd ..
```

**注意**：如果安装过程中出现错误，可能是网络问题，可以尝试：
```bash
# 使用国内镜像源（淘宝镜像）
npm config set registry https://registry.npmmirror.com
npm install
```

---

### 第四步：构建项目

#### 4.1 构建前端

```bash
# 确保在项目根目录
cd /www/wwwroot/goofishcbot

# 构建前端
npm run build:frontend

# 等待构建完成（可能需要 1-2 分钟）
```

构建成功后，会看到类似输出：
```
Application bundle generation complete.
Output location: /www/wwwroot/goofishcbot/frontend/dist/frontend
```

#### 4.2 构建后端（可选，生产环境推荐）

```bash
# 构建 TypeScript 代码
npm run build
```

---

### 第五步：配置和启动

#### 5.1 测试运行（开发模式）

```bash
# 在项目根目录执行
npm run dev
```

如果看到以下输出，说明启动成功：
```
服务器启动在端口 3000
访问 http://localhost:3000 打开管理面板
```

**注意**：开发模式会占用终端，按 `Ctrl+C` 可以停止。

#### 5.2 使用 PM2 管理（生产环境推荐）

**安装 PM2：**
```bash
npm install -g pm2
```

**启动应用：**
```bash
# 在项目根目录执行
npm run pm2:start
```

**查看状态：**
```bash
npm run pm2:status
```

**查看日志：**
```bash
npm run pm2:logs
```

**停止应用：**
```bash
npm run pm2:stop
```

**重启应用：**
```bash
npm run pm2:restart
```

---

### 第六步：配置防火墙和端口

#### 6.1 开放端口 3000

**宝塔面板：**
1. 进入「安全」→「防火墙」
2. 点击「添加规则」
3. 端口：`3000`
4. 协议：`TCP`
5. 备注：`GoofishCBot`
6. 点击「提交」

**1Panel：**
1. 进入「安全」→「防火墙」
2. 添加规则，开放端口 3000

**通过命令行：**
```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw reload

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

#### 6.2 测试访问

在浏览器中访问：
```
http://你的服务器IP:3000
```

如果能看到管理界面，说明部署成功！

---

### 第七步：配置反向代理（可选，推荐）

如果你有域名，建议配置反向代理，使用域名访问而不是 IP:端口。

#### 7.1 创建网站（宝塔面板）

1. 进入「网站」→「添加站点」
2. 域名：填写你的域名（如：`bot.example.com`）
3. 根目录：选择 `/www/wwwroot/goofishcbot/public`
4. PHP 版本：选择「纯静态」
5. 点击「提交」

#### 7.2 配置反向代理

1. 进入「网站」→ 找到你的网站 → 点击「设置」
2. 进入「反向代理」标签
3. 点击「添加反向代理」
4. 代理名称：`goofishcbot`
5. 目标 URL：`http://127.0.0.1:3000`
6. 发送域名：`$host`
7. 点击「提交」

#### 7.3 配置 SSL 证书（可选）

1. 在网站设置中，进入「SSL」标签
2. 选择「Let's Encrypt」免费证书
3. 点击「申请」
4. 申请成功后，开启「强制 HTTPS」

现在可以通过 `https://你的域名` 访问了！

---

## 🔧 常见问题

### Q1: npm install 很慢或失败
**解决方案：**
```bash
# 使用国内镜像
npm config set registry https://registry.npmmirror.com
npm install
```

### Q2: 端口 3000 被占用
**解决方案：**
```bash
# 查看占用端口的进程
lsof -i :3000
# 或
netstat -tulpn | grep 3000

# 修改端口（编辑 src/core/constants.ts）
# 将 PORT: 3000 改为其他端口，如 3001
```

### Q3: PM2 启动失败
**解决方案：**
```bash
# 检查日志
npm run pm2:logs

# 手动启动查看错误
cd /www/wwwroot/goofishcbot
node dist/index.js
```

### Q4: 前端页面空白
**解决方案：**
```bash
# 重新构建前端
cd /www/wwwroot/goofishcbot
npm run build:frontend

# 检查 public 目录是否存在
ls -la public/
```

### Q5: 数据库文件权限问题
**解决方案：**
```bash
# 确保 data 目录有写权限
chmod 755 /www/wwwroot/goofishcbot/data
chown -R www:www /www/wwwroot/goofishcbot/data
```

---

## 📝 维护命令

### 更新项目
```bash
cd /www/wwwroot/goofishcbot

# 停止服务
npm run pm2:stop

# 备份数据库（重要！）
cp data/goofishcbot.db data/goofishcbot.db.backup

# 拉取最新代码（如果使用 Git）
git pull

# 重新安装依赖
npm install
cd frontend && npm install && cd ..

# 重新构建
npm run build:frontend
npm run build

# 重启服务
npm run pm2:start
```

### 查看日志
```bash
# PM2 日志
npm run pm2:logs

# 应用日志
tail -f logs/$(date +%Y-%m-%d)/*.log
```

### 备份数据
```bash
# 备份数据库
cp data/goofishcbot.db /backup/goofishcbot-$(date +%Y%m%d).db

# 备份整个项目
tar -czf goofishcbot-backup-$(date +%Y%m%d).tar.gz /www/wwwroot/goofishcbot
```

---

## ✅ 验证安装

安装完成后，请验证以下功能：

1. ✅ 访问 `http://你的服务器IP:3000` 能看到管理界面
2. ✅ 账号管理页面可以正常打开
3. ✅ 可以添加闲鱼账号（需要有效的 Cookie）
4. ✅ 系统设置页面可以正常访问
5. ✅ 日志页面可以查看系统日志

---

## 📞 获取帮助

如果遇到问题，请：
1. 查看日志文件：`logs/` 目录
2. 检查 PM2 状态：`npm run pm2:status`
3. 查看本文档的「常见问题」部分
4. 访问项目 GitHub Issues 页面

---

**祝您使用愉快！** 🎉
